# Event Planner API

## Обзор

Это MVP‑реализация API сервиса для планирования и записи на мероприятия.  Проект задуман как модульная система, которую легко расширять: базовые компоненты (мероприятия, пользователи, платежи) вынесены в отдельные пакеты, маршруты сгруппированы по версиям (`/api/v1`), а конфигурация подгружается из переменных окружения.  В текущей реализации данные хранятся в памяти, но структура сервиса готова к подключению полноценной базы данных и миграций.

Проект состоит из следующих основных частей:

* `app/main.py` — точка входа, собирающая приложение FastAPI, настраивающая логирование и подключающая версионированные роутеры.
* `app/api/v1/endpoints` — реализация маршрутов для каждого домена (events, users, payments).  Каждый файл определяет `APIRouter` и описывает базовые CRUD‑операции.
* `app/services` — слой бизнес‑логики.  Сейчас сервисы используют in‑memory списки для хранения данных, но при переходе на БД будет достаточно заменить эту реализацию на запросы через ORM.
* `app/schemas` — Pydantic‑схемы, описывающие входные и выходные данные.  Разделение схем и моделей позволяет сохранить стабильный API при изменениях БД.
* `app/core` — поддерживающие модули (настройки, логирование, безопасность).  Здесь реализован простой механизм генерации токенов, который следует заменить на полноценную JWT‑авторизацию.

## Запуск

Для локального запуска потребуется Python 3.11+ и установленные зависимости `fastapi` и `uvicorn`.  В данной среде зависимости уже установлены.  Запустить сервер можно так:

```bash
uvicorn event_planner_api.app.main:app --reload
```

По умолчанию сервер будет слушать порт 8000.  Документация Swagger доступна по адресу `http://localhost:8000/docs`.

## Конфигурация

Настройки читаются из переменных окружения:

| Переменная                      | Описание                                           | Значение по умолчанию             |
|---------------------------------|----------------------------------------------------|-----------------------------------|
| `PROJECT_NAME`                  | Название проекта                                   | `Event Planner API`               |
| `API_VERSION`                   | Версия API                                         | `1.0.0`                           |
| `DEBUG`                         | Режим отладки                                      | `false`                           |
| `LOG_LEVEL`                     | Уровень логирования                                | `INFO`                            |
| `SECRET_KEY`                    | Секретный ключ для подписи токенов                 | `change_me`                       |
| `ACCESS_TOKEN_EXPIRE_MINUTES`   | Время жизни токена доступа в минутах              | `1440` (сутки)                    |
| `ALGORITHM`                     | Алгоритм подписи токена (зарезервирован под JWT)  | `HS256`                           |

В настоящей реализации токены создаются простым base64‑кодированием JSON — этот механизм предназначен только для тестирования.  Перед выходом в продакшн следует реализовать полноценные JWT‑токены с использованием библиотеки `python‑jose` или аналогичной и надёжно хранить `SECRET_KEY`.

## API эндпоинты

Ниже приведены основные маршруты версии v1 с кратким описанием.  Каждый из них снабжён подробными docstring’ами в исходном коде, которые будут отображаться в Swagger.

### Пользователи (`/api/v1/users`)

* `POST /api/v1/users/` — регистрация пользователя.  Принимает JSON с полями `email`, `full_name`, `password`.  В будущем пароль будет хешироваться (используйте `bcrypt`/`argon2`) и храниться в базе, а также появится подтверждение e‑mail.
* `POST /api/v1/users/login` — аутентификация.  Принимает те же поля, что и регистрация.  На выходе возвращает `access_token` и `token_type`.  В дальнейшем планируется отделить схему `UserLogin` и добавить refresh‑токены.
* `GET /api/v1/users/` — список пользователей.  Сейчас доступен всем аутентифицированным пользователям; позднее будет ограничен только администраторами.

### Мероприятия (`/api/v1/events`)

* `POST /api/v1/events/` — создание мероприятия.  Требует авторизации (в будущем — проверка роли «планировщик»).  Принимает поля `title`, `description`, `start_time`, `duration_minutes`, `max_participants`, `is_paid`.  В будущем будет расширено полями `price`, `allowed_payment_methods`, `tags` и т.д.
* `GET /api/v1/events/` — список мероприятий.  Пока возвращает все события без фильтрации.  Предполагается добавить параметры запроса для фильтрации по дате, статусу оплаты, доступности мест и пагинации.

### Платежи (`/api/v1/payments`)

* `POST /api/v1/payments/` — создание платежа.  Принимает `amount`, `currency`, `description`.  В реальной интеграции сюда добавятся поля `payment_method`, `event_id`, `status`, а также обработка webhooks от платёжного провайдера.
* `GET /api/v1/payments/` — список платежей.  Сейчас возвращает все платежи.  Будет дополнен фильтрацией по пользователю, периоду и статусу платежа.

## Рекомендации по расширению

* **Реализация БД**: текущие сервисы (`UserService`, `EventService`, `PaymentService`) используют списки в памяти.  Для перехода на полноценную БД стоит выбрать PostgreSQL и использовать ORM (SQLAlchemy или `encode/databases` с SQLAlchemy 2.0).  Создайте модели для каждой таблицы, настройте Alembic для миграций и обновите сервисы для выполнения реальных запросов.  Используйте транзакции и индексы там, где необходимо.
* **Миграции и деплой**: подготовьте `Dockerfile` и `docker‑compose.yml`, где будут сервисы API, БД и брокер задач (например, Redis для очередей Celery/RQ).  Добавьте автоматический запуск миграций в `entrypoint.sh`.
* **Роли и авторизация**: в базе данных должно быть несколько таблиц: `roles` (для описания доступных ролей и прав) и связь `user.role_id`.  Реализуйте декораторы/зависимости, проверяющие права доступа для каждого эндпоинта.
* **Платежи**: создайте абстракцию для платёжных провайдеров.  Каждая платёжная система (ЮKassa, Stripe и т. д.) будет реализовывать общий интерфейс.  Поддержите разные статусы платежей и возвраты.  Для офлайн‑оплаты добавьте поле `is_offline` и флаг подтверждения оператором.
* **События и лист ожидания**: таблица `bookings` должна содержать статус (pending/confirmed/cancelled) и ссылку на `payment_id`.  Для реализации листа ожидания создайте таблицу `waitlist` с полями `event_id`, `user_id`, `position`, `created_at`; при освобождении места первым в очереди отправляется уведомление.

## Предлагаемая схема БД

Ниже приведён пример отношений между основными сущностями.  Поля в таблицах приведены не исчерпывающими — их можно расширять в процессе развития проекта.

### `users`

| Поле        | Тип               | Описание                               |
|-------------|------------------|-----------------------------------------|
| `id`        | `serial` (PK)    | Уникальный идентификатор пользователя   |
| `email`     | `varchar`        | Адрес электронной почты (уникальный)    |
| `full_name` | `varchar`        | Полное имя                              |
| `password`  | `varchar`        | Хешированный пароль                     |
| `role_id`   | `integer`        | Ссылка на таблицу `roles`               |
| `balance`   | `numeric`        | Текущий баланс пользователя             |
| `disabled`  | `boolean`        | Флаг деактивации                        |
| `created_at`| `timestamp`      | Дата создания                           |
| `updated_at`| `timestamp`      | Дата последнего изменения               |

### `roles`

| Поле    | Тип          | Описание                             |
|---------|--------------|--------------------------------------|
| `id`    | `serial` (PK)| Уникальный идентификатор роли        |
| `name`  | `varchar`    | Название роли (admin, support, etc.) |
| `permissions` | `jsonb`| Набор прав в виде JSON               |

### `events`

| Поле               | Тип               | Описание                                              |
|--------------------|-------------------|--------------------------------------------------------|
| `id`               | `serial` (PK)     | Уникальный идентификатор мероприятия                   |
| `title`            | `varchar`         | Название мероприятия                                   |
| `description`      | `text`            | Описание                                               |
| `start_time`       | `timestamp`       | Время начала                                           |
| `duration_minutes` | `integer`         | Длительность в минутах                                 |
| `max_participants` | `integer`         | Максимальное число участников                          |
| `is_paid`          | `boolean`         | Флаг платности                                         |
| `price`            | `numeric`         | Стоимость участия (если платное)                      |
| `created_by`       | `integer` (FK)    | Пользователь‑создатель                                 |
| `created_at`       | `timestamp`       | Дата создания                                          |
| `updated_at`       | `timestamp`       | Дата последнего изменения                              |

### `bookings`

| Поле        | Тип               | Описание                                                    |
|-------------|-------------------|--------------------------------------------------------------|
| `id`        | `serial` (PK)     | Уникальный идентификатор бронирования                       |
| `user_id`   | `integer` (FK)    | Пользователь, сделавший бронирование                        |
| `event_id`  | `integer` (FK)    | Ссылается на мероприятие                                    |
| `group_size`| `integer`         | Количество человек в группе                                 |
| `payment_id`| `integer` (FK)    | Ссылка на платеж, если оплата осуществлялась                |
| `status`    | `varchar`         | Статус записи (pending, confirmed, cancelled, waitlisted)    |
| `created_at`| `timestamp`       | Дата создания                                               |
| `updated_at`| `timestamp`       | Дата последнего изменения                                   |

### `waitlist`

| Поле         | Тип               | Описание                                         |
|--------------|-------------------|---------------------------------------------------|
| `id`         | `serial` (PK)     | Уникальный идентификатор записи в листе ожидания |
| `event_id`   | `integer` (FK)    | Связь с мероприятием                             |
| `user_id`    | `integer` (FK)    | Пользователь, ожидающий места                    |
| `position`   | `integer`         | Позиция в очереди                                |
| `created_at` | `timestamp`       | Дата добавления в очередь                       |

### `payments`

| Поле            | Тип               | Описание                                                      |
|-----------------|-------------------|----------------------------------------------------------------|
| `id`            | `serial` (PK)     | Уникальный идентификатор платежа                               |
| `user_id`       | `integer` (FK)    | Кто совершил платеж                                           |
| `event_id`      | `integer` (FK)    | За какое мероприятие (nullable для пополнения баланса)         |
| `amount`        | `numeric`         | Сумма платежа                                                 |
| `currency`      | `varchar`         | Валюта                                                        |
| `payment_method`| `varchar`         | Способ оплаты (card, cash, yookassa, support)                 |
| `status`        | `varchar`         | Статус (pending, success, failed, refunded)                   |
| `created_at`    | `timestamp`       | Время создания                                               |
| `updated_at`    | `timestamp`       | Время последнего обновления                                   |

### `support_messages`

| Поле         | Тип               | Описание                                              |
|--------------|-------------------|--------------------------------------------------------|
| `id`         | `serial` (PK)     | Уникальный идентификатор сообщения поддержки           |
| `user_id`    | `integer` (FK)    | От кого сообщение                                      |
| `admin_id`   | `integer` (FK)    | Кто отвечает (nullable, пока не назначен)             |
| `content`    | `text`            | Текст сообщения                                        |
| `created_at` | `timestamp`       | Время отправки                                         |
| `updated_at` | `timestamp`       | Время последнего изменения                             |

### `reviews`

| Поле         | Тип               | Описание                                             |
|--------------|-------------------|-------------------------------------------------------|
| `id`         | `serial` (PK)     | Уникальный идентификатор отзыва                      |
| `user_id`    | `integer` (FK)    | Кто оставил отзыв                                    |
| `event_id`   | `integer` (FK)    | Для какого мероприятия                               |
| `rating`     | `integer`         | Оценка (1–5)                                         |
| `comment`    | `text`            | Текст отзыва                                         |
| `approved`   | `boolean`         | Принят ли отзыв модератором                           |
| `moderated_by`| `integer` (FK)    | Кто модерировал (null, если не модерация)             |
| `created_at` | `timestamp`       | Время создания                                       |

### `mailings`

| Поле         | Тип               | Описание                                              |
|--------------|-------------------|--------------------------------------------------------|
| `id`         | `serial` (PK)     | Уникальный идентификатор рассылки                     |
| `created_by` | `integer` (FK)    | Кто создал рассылку                                   |
| `title`      | `varchar`         | Название/тема рассылки                                |
| `content`    | `text`            | Содержание                                            |
| `filters`    | `jsonb`           | Условия отбора аудитории (статус оплаты, посещения…)  |
| `scheduled_at`| `timestamp`      | Время запланированной отправки (nullable)             |
| `created_at` | `timestamp`       | Дата создания                                         |

### `settings`

| Поле   | Тип          | Описание                                      |
|--------|--------------|-----------------------------------------------|
| `key`  | `varchar` (PK)| Ключ настройки                               |
| `value`| `text`        | Значение (можно хранить JSON)                 |
| `type` | `varchar`     | Тип данных (string, number, bool, json)      |

### Аудит

Для ведения истории изменений важно иметь отдельную таблицу `audit_logs`, в которой будут храниться сведения о пользователях, действиях (например, создание/изменение/удаление записи), объекте и времени операции.

## Итог

Созданный каркас API придерживается принципа разделения ответственности: маршруты, сервисы и схемы разделены по доменам, конфигурация вынесена отдельно.  Логирование настроено централизованно, а безопасность реализована через авторизационный токен.  Документация и предложенная схема БД помогут плавно перейти от MVP к полноценному сервису, сохранив обратную совместимость за счёт версионирования.  Каждый метод в коде снабжён docstring’ами, где описывается его назначение и будущие направления развития, что упрощает сопровождение и дальнейшее расширение функциональности.