# Полная спецификация REST‑API

Этот документ описывает полный набор маршрутов API сервиса планирования и управления мероприятиями. Все запросы имеют префикс `/api/v1` и требуют аутентификации через JWT (кроме регистрации и входа). Пользователи системы — это сотрудники админ‑состава с различными ролями; обычные клиенты обращаются к API только через доверенный Telegram‑бот, который выполняет запросы от их имени.

## Аутентификация

Для всех защищённых эндпоинтов в заголовке запроса должен присутствовать JWT‑токен:

```
Authorization: Bearer <token>
```

Токен выдаётся методом `/users/login`. Дополнительные заголовки (`Content‑Type: application/json`) добавляются автоматически клиентской библиотекой.

### Статический токен супер‑администратора

Для интеграций, которым требуется полный доступ к API без прохождения логина, можно установить переменную окружения `SUPER_ADMIN_TOKEN`.  Если этот токен передан в заголовке `Authorization` (формат `Bearer <token>`), сервис воспринимает запрос как выполненный от имени супер‑администратора (`role_id=1`).  Используйте статический токен с осторожностью и меняйте его регулярно, так как его компрометация даёт полный доступ ко всем функциям.

### Токены для ботов и внешних сервисов

Если вам необходимо интегрировать несколько ботов или внешних систем с API, вы можете задать переменную окружения `BOT_TOKENS` со списком доверенных токенов через запятую.  Запросы, в которых `Authorization: Bearer <token>` совпадает с одним из этих значений, будут аутентифицированы без JWT.  Роль, которая будет присвоена таким токенам, задаётся переменной `BOT_ROLE_ID` (по умолчанию `2` — администратор).  Например:

```
BOT_TOKENS="bot_token_telegram,bot_token_vk"
BOT_ROLE_ID=2
```

В этом случае оба токена авторизуют запрос с правами администратора.  Вы можете установить `BOT_ROLE_ID=3`, чтобы ограничить возможности бота ролями обычного пользователя.

### Социальный вход (social login)

Пользователи, взаимодействующие через мессенджеры (Telegram, VK и др.), могут получать JWT‑токен без учётной записи с e‑mail и паролем.  Для этого используется endpoint `POST /api/v1/users/social-login`.

**Тело запроса**

```json
{
  "social_provider": "telegram",
  "social_id": "123456789",
  "full_name": "Иван Иванов"
}
```

* `social_provider` — код внешнего сервиса (`telegram`, `vk`, `whatsapp`, и т.п.).
* `social_id` — уникальный идентификатор пользователя в этом сервисе.
* `full_name` — необязательное поле с именем пользователя; используется только при создании новой учётной записи.

**Ответы**

- `200 OK` — возвращает JSON с полями `access_token` и `token_type`.  Если пользователь с указанной парой (`social_provider`, `social_id`) не найден, создаётся новая запись (роль `user`), и затем выдаётся токен.
- `401 Unauthorized` — если учётная запись заблокирована.

## Пользователи и роли

### Регистрация пользователя

`POST /api/v1/users/`

- **Тело запроса**

  ```json
  {
    "email": "user@example.com",
    "full_name": "Иван Иванов",
    "password": "securePassword"
  }
  ```
- **Ответы**
  - `201 Created` — возвращает созданного пользователя (поля `id`, `email`, `full_name`, `disabled`).
  - `400 Bad Request` — некорректные данные или отсутствующие поля.
  - `409 Conflict` — пользователь с таким email уже существует.

### Вход в систему

`POST /api/v1/users/login`

- **Тело запроса**

  ```json
  {
    "email": "user@example.com",
    "password": "securePassword"
  }
  ```
- **Ответы**
  - `200 OK` — возвращает JSON с полями `access_token` и `token_type` (`bearer`).
  - `401 Unauthorized` — неверная пара email/пароль.

### Список пользователей

`GET /api/v1/users/`

- **Заголовки:** `Authorization`
- **Ответ:** массив пользователей.
- **Параметры:** пока не поддерживает фильтры и сортировку.

### Обновление пользователя

`PUT /api/v1/users/{user_id}`

- **Заголовки:** `Authorization`
- **Тело запроса** — JSON c любыми из полей:

  - `full_name` — новое имя;
  - `disabled` — логическое значение для блокировки пользователя;
  - `password` — новый пароль;
  - `role_id` — назначить новую роль (только для админов).

- **Ответы**
  - `200 OK` — обновлённый пользователь.
  - `403 Forbidden` — попытка изменить чужой профиль обычным пользователем или смена роли не администратором.
  - `404 Not Found` — пользователь не существует.

### Удаление пользователя

`DELETE /api/v1/users/{user_id}`

- **Заголовки:** `Authorization`
- **Ответы**
  - `204 No Content` — пользователь и связанные записи удалены.
  - `400 Bad Request` — попытка удалить себя или первого (главного) администратора.
  - `403 Forbidden` — недостаточно прав (удалять может только супер‑админ).
  - `404 Not Found` — пользователь не найден.

### Работа с ролями

- `GET /api/v1/roles/` — получить список ролей.
- `POST /api/v1/roles/` — создать роль: тело `{ "name": "support", "permissions": ["tickets:view"] }`.
- `PUT /api/v1/roles/{id}` — изменить имя или набор разрешений.
- `DELETE /api/v1/roles/{id}` — удалить роль.
- `POST /api/v1/roles/assign` — присвоить роль пользователю: `{ "user_id": 2, "role_id": 3 }`.

Все операции с ролями требуют административных прав.

## Мероприятия (Events)

### Создание события

`POST /api/v1/events/`

- **Заголовки:** `Authorization`
- **Тело запроса**

  ```json
  {
    "title": "Встреча сообщества",
    "description": "Описание мероприятия",
    "start_time": "2025-10-01T18:00:00",
    "duration_minutes": 120,
    "max_participants": 50,
    "is_paid": true,
    "price": 500
  }
  ```
- **Ответы**
  - `201 Created` — созданное событие.
  - `403 Forbidden` — недостаточно прав (только администраторы).

### Получение списка событий

`GET /api/v1/events`

- **Параметры запроса (опциональные):**
  - `limit`, `offset` — пагинация.
  - `sort_by` — поле для сортировки (`id`, `title`, `start_time`, `duration_minutes`, `max_participants`).
  - `order` — `asc`/`desc`.
  - `is_paid` — `true`/`false`.
  - `date_from`, `date_to` — отбор по дате начала (ISO‑строка).
- **Ответ:** массив событий.

### Получение одного события

`GET /api/v1/events/{event_id}`

- **Ответы**
  - `200 OK` — объект события.
  - `404 Not Found` — событие не найдено.

### Обновление события

`PUT /api/v1/events/{event_id}`

- **Заголовки:** `Authorization`
- **Тело запроса:** частичный объект с любыми изменяемыми полями (`title`, `description`, `start_time`, `duration_minutes`, `max_participants`, `is_paid`, `price`).
- **Ответы**
  - `200 OK` — обновлённое событие.
  - `403 Forbidden` — недостаточно прав.
  - `404 Not Found` — событие не найдено.

### Дублирование события

`POST /api/v1/events/{event_id}/duplicate`

- **Заголовки:** `Authorization`
- **Тело запроса:** `{ "start_time": "2025-12-05T18:00:00" }`
- **Ответ:** `201 Created` — новое событие.
- **Ошибки:** `404 Not Found` — исходное событие не существует; `403 Forbidden` — недостаточно прав.

### Удаление события

`DELETE /api/v1/events/{event_id}`

- **Заголовки:** `Authorization`
- **Ответы**
  - `204 No Content` — событие удалено.
  - `404 Not Found` — не найдено.
  - `403 Forbidden` — недостаточно прав.

### Список участников события

`GET /api/v1/events/{event_id}/participants`

- **Заголовки:** `Authorization`
- **Параметры:** `limit`, `offset`, `sort_by` (`id`, `user_id`, `group_size`, `status`, `created_at`, `is_paid`, `is_attended`), `order` (`asc`/`desc`).
- **Ответ:** массив объектов бронирования.
- **Ошибки:** `403 Forbidden` — доступ только администратору.

## Бронирования (Bookings)

### Записаться на событие

`POST /api/v1/events/{event_id}/bookings`

- **Заголовки:** `Authorization`
- **Тело запроса:** объект с полями:
  - `group_size` — количество участников в бронировании, по умолчанию 1.
  - `group_names` — (необязательный) список имён участников.  Длина списка может быть меньше или равна `group_size`; оставшиеся места будут безымянными.
- **Ответы**
  - `201 Created` — бронирование создано.  Возвращает объект бронирования; если были переданы имена, они присутствуют в ответе.
  - `400 Bad Request` — мест нет (пользователь помещается в лист ожидания; текст ошибки: «Event is full. You have been added to the waitlist.»).
  - `404 Not Found` — событие не существует.

### Просмотр бронирований

`GET /api/v1/events/{event_id}/bookings`

- **Заголовки:** `Authorization`
- **Параметры:** `limit`, `offset`, `sort_by`, `order` — аналогично списку участников.
- **Ответы**
  - `200 OK` — список бронирований.
  - `403 Forbidden` — только для администраторов.

#### Получить одно бронирование

`GET /api/v1/bookings/{booking_id}`

- **Заголовки:** `Authorization`
- **Ответ:** объект бронирования, содержащий поля `id`, `user_id`, `event_id`, `group_size`, `status`, `is_paid`, `is_attended`, `created_at` и (если передавались) `group_names`.
- **Ошибки:** `403 Forbidden` — пользователь пытается просмотреть чужую бронь без прав администратора; `404 Not Found` — бронь не существует.

#### Обновление бронирования

`PUT /api/v1/bookings/{booking_id}`

- **Заголовки:** `Authorization`
- **Тело запроса:** JSON с любым из полей `group_size` или `group_names` для изменения размера группы либо имён участников.
- **Ответ:** `200 OK` — обновлённая бронь.
- **Ошибки:** `403 Forbidden` — попытка изменить чужую бронь без прав администратора; `404 Not Found` — бронирование не найдено.

### Лист ожидания

`GET /api/v1/events/{event_id}/waitlist`

- **Заголовки:** `Authorization`
- **Ответ:** список пользователей в листе ожидания.
- **Ошибки:** `403 Forbidden` — только администратор.

### Управление листом ожидания

Пока мероприятие заполнено, новые заявители помещаются в лист ожидания.  По умолчанию сервис автоматически продвигает людей из листа ожидания при освобождении мест, но администратор может отключить автоматическое продвижение настройкой `waitlist_auto_promote=false` через эндпоинты `/api/v1/settings/waitlist_auto_promote` (см. раздел «Настройки»).  В этом случае при удалении брони для каждого человека из листа ожидания создаётся задача для ботов, и пользователю отправляется сообщение с кнопкой **«Записать»**.  Пользователь должен нажать на кнопку (или вызвать соответствующий HTTP‑запрос), чтобы подтвердить участие.  Если к моменту нажатия мест уже нет, сервис вернёт ошибку.

- `GET /api/v1/waitlist/{entry_id}` — получить запись листа ожидания (доступно только администраторам).  Возвращает поля `id`, `event_id`, `user_id`, `position` и `created_at`.
- `PUT /api/v1/waitlist/{entry_id}` — изменить позицию записи в листе ожидания (только администратор).  В теле запроса следует указать новое поле `position`.
- `DELETE /api/v1/waitlist/{entry_id}` — удалить запись из листа ожидания (только администратор).  После удаления позиции остальных записей сдвигаются, чтобы не было пропусков.
- `POST /api/v1/waitlist/{entry_id}/book` — подтвердить бронь из листа ожидания.  Этот метод вызывают пользователи, получившие уведомление.  Сервис проверяет, что запись принадлежит текущему пользователю и что место ещё свободно, создаёт бронирование с `group_size=1` и удаляет запись из листа ожидания.  Если мест уже нет, возвращается `409 Conflict`.

Пример использования кнопки в чате:

```http
POST /api/v1/waitlist/12/book
Authorization: Bearer <user_token>

HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": 42,
  "user_id": 5,
  "event_id": 3,
  "group_size": 1,
  "status": "pending",
  "created_at": "2025-09-05T12:34:56",
  "group_names": null
}
```

### Переключение оплаты и посещения

- `POST /api/v1/bookings/{booking_id}/toggle-payment`
- `POST /api/v1/bookings/{booking_id}/toggle-attendance`

**Заголовки:** `Authorization`

**Ответ:** обновлённое бронирование.

**Ошибки:** `403 Forbidden` — только администратор; `404 Not Found` — бронирование не найдено.

### Удаление бронирования

`DELETE /api/v1/bookings/{booking_id}`

- **Заголовки:** `Authorization`
- **Ответы**
  - `204 No Content` — бронирование удалено.
  - `404 Not Found` — бронирование не найдено.
  - `403 Forbidden` — только администратор.

## Платежи

### Создание платежа

`POST /api/v1/payments`

- **Заголовки:** `Authorization`
- **Тело запроса**

  ```json
  {
    "event_id": 1,
    "amount": 500,
    "currency": "RUB",
    "provider": "yookassa" | "support" | "cash",
    "description": "Оплата участия"
  }
  ```
- **Ответ:** `201 Created` — создан платёж. Поля ответа: `id`, `amount`, `currency`, `description`, `created_at`, `event_id`, `provider`, `status`, `external_id`.
- **Ошибки:** `400 Bad Request` — недопустимая сумма или неизвестный провайдер; `404 Not Found` — событие не существует.

### Просмотр платежей

`GET /api/v1/payments`

- **Заголовки:** `Authorization`
- **Параметры:** `event_id`, `provider`, `status`, `limit`, `offset`, `sort_by` (`created_at`, `amount`), `order` (`asc`/`desc`).
- **Ответ:** список платежей. Администраторы видят все, остальные — только собственные.

### Подтверждение платежа

`POST /api/v1/payments/{payment_id}/confirm`

- **Заголовки:** `Authorization`
- **Ответ:** обновлённый платёж (`status` → `success`). Одновременно связанное бронирование помечается как оплачено.
- **Ошибки:** `403 Forbidden` — только администратор; `404 Not Found` — платёж не найден.

### Обработка вебхуков ЮKassa

`POST /api/v1/payments/yookassa/callback`

- **Заголовки:** подпись ЮKassa
- **Тело:** JSON от платёжной системы. В реальной интеграции проверяется подпись и обновляется соответствующий платёж.
- **Ответ:** `200 OK`.

### Удаление платежа

`DELETE /api/v1/payments/{payment_id}`

- **Заголовки:** `Authorization`
- **Ответы**
  - `204 No Content` — платёж удалён.
  - `404 Not Found` — платёж не найден.
  - `403 Forbidden` — только администратор.

## Поддержка (Support)

### Создание тикета

`POST /api/v1/support/tickets`

- **Заголовки:** `Authorization`
- **Тело запроса**

  ```json
  {
    "subject": "Проблема",
    "content": "Описание проблемы",
    "attachments": ["file1.png", "file2.pdf"]
  }
  ```
- **Ответ:** `201 Created` — созданный тикет (`id`, `user_id`, `subject`, `status`, `created_at`, `updated_at`).

### Список тикетов

`GET /api/v1/support/tickets`

- **Заголовки:** `Authorization`
- **Параметры:** `status`, `limit`, `offset`, `sort_by` (`created_at`, `updated_at`, `status`), `order` (`asc`/`desc`).
- **Ответ:** список тикетов. Администраторы видят все; обычный пользователь — только свои.

### Получение тикета и сообщений

`GET /api/v1/support/tickets/{ticket_id}`

- **Заголовки:** `Authorization`
- **Ответ:** объект с полями `ticket` (данные тикета) и `messages` (список сообщений с полями `content`, `sender_role`, `attachments`, `created_at`).
- **Ошибки:** `403 Forbidden` — пользователь не имеет доступа; `404 Not Found` — тикет не найден.

### Ответ на тикет

`POST /api/v1/support/tickets/{ticket_id}/reply`

- **Заголовки:** `Authorization`
- **Тело запроса**

  ```json
  {
    "content": "Ответ оператора",
    "attachments": ["image.png"]
  }
  ```
- **Ответ:** `201 Created` — созданное сообщение.
- **Ошибки:** `403 Forbidden` — нет прав (обычный пользователь пытается ответить в чужой тикет); `404 Not Found` — тикет не существует.

### Обновление статуса тикета

`PUT /api/v1/support/tickets/{ticket_id}/status`

- **Заголовки:** `Authorization`
- **Тело запроса:** `{ "status": "resolved" }` (поддерживаются `open`, `resolved`, `closed`).
- **Ответ:** `200 OK` — обновлённый тикет.
- **Ошибки:** `403 Forbidden` — только администратор; `404 Not Found` — тикет не найден.

### Удаление тикета

`DELETE /api/v1/support/tickets/{ticket_id}`

- **Заголовки:** `Authorization`
- **Ответы**
  - `204 No Content` — тикет и связанные сообщения удалены.
  - `404 Not Found` — тикет не найден.
  - `403 Forbidden` — только администратор.

## Отзывы (Reviews)

### Создание отзыва

`POST /api/v1/reviews`

- **Заголовки:** `Authorization`
- **Тело запроса**

  ```json
  {
    "event_id": 1,
    "rating": 5,
    "comment": "Отличное мероприятие!"
  }
  ```
- **Ответ:** `201 Created` — новый отзыв c `approved=false`.
- **Ошибки:** `400 Bad Request` — пользователь не участвовал в событии или рейтинг вне диапазона 1–5.

### Список отзывов

`GET /api/v1/reviews`

- **Заголовки:** `Authorization`
- **Параметры:** `event_id`, `user_id`, `approved`, `limit`, `offset`, `sort_by` (`created_at`, `rating`), `order` (`asc`/`desc`).
- **Ответ:** список отзывов; обычный пользователь видит только свои.

### Получение отзыва

`GET /api/v1/reviews/{review_id}`

- **Ответ:** объект отзыва.
- **Ошибки:** `403 Forbidden` — нет доступа; `404 Not Found` — отзыв не найден.

### Модерация отзыва

`POST /api/v1/reviews/{review_id}/moderate`

- **Заголовки:** `Authorization`
- **Тело запроса:** `{ "approved": true, "reason": "Спасибо за отзыв" }`
- **Ответ:** `200 OK` — обновлённый отзыв.
- **Ошибки:** `403 Forbidden` — только администратор; `404 Not Found`.

### Удаление отзыва

`DELETE /api/v1/reviews/{review_id}`

- **Заголовки:** `Authorization`
- **Ответы**
  - `204 No Content` — отзыв удалён.
  - `404 Not Found` — отзыв не найден.
  - `403 Forbidden` — удалить может только администратор или автор.

## Рассылки (Mailings)

### Создание рассылки

`POST /api/v1/mailings`

- **Заголовки:** `Authorization`
**Тело запроса**

  ```json
  {
    "title": "Новое мероприятие",
    "content": "Мы рады сообщить...",
    "filters": {
      "event_id": 5,
      "is_paid": true,
      "is_attended": false
    },
    "messengers": ["telegram", "vk"]
  }
  ```

**Поля запроса:**

- `title` — заголовок рассылки (строка).
- `content` — текст сообщения (строка).
- `filters` — объект с критериями для отбора получателей. Примеры: `{ "event_id": 5, "is_paid": true, "is_attended": false }`. Отсутствие фильтров означает, что рассылка отправляется всем пользователям.
- `messengers` — *опциональный* массив кодов мессенджеров, в которые нужно отправить рассылку. Допустимые значения: `telegram`, `vk`, `max`. Если поле не указано или пустое, задачи для ботов не создаются и рассылка сохраняется лишь для дальнейшего просмотра.
- `scheduled_at` — *опционально* ISO‑дата/время для отложенной отправки (если не указано, рассылка отправляется сразу при вызове `/send`).

**Ответ:** `201 Created` — созданная рассылка.
**Ошибки:** `400 Bad Request` — неверный формат фильтров или список `messengers` содержит неподдерживаемые значения.

### Список рассылок

`GET /api/v1/mailings`

- **Заголовки:** `Authorization`
- **Параметры:** `limit`, `offset`, `sort_by` (`created_at`, `title`), `order`.
- **Ответ:** список рассылок.

### Получение одной рассылки

`GET /api/v1/mailings/{mailing_id}`

- **Ответ:** объект рассылки и логи отправки.
- **Ошибки:** `404 Not Found`.

### Запуск рассылки

`POST /api/v1/mailings/{mailing_id}/send`

- **Заголовки:** `Authorization`
- **Ответ:** `200 OK` — отправка инициирована, в `mailing_logs` создаются записи для каждого получателя.
- **Ошибки:** `404 Not Found`, `403 Forbidden`.

### Удаление рассылки

`DELETE /api/v1/mailings/{mailing_id}`

- **Ответы**
  - `204 No Content` — рассылка и связанные логи удалены.
  - `404 Not Found` — не найдено.

## Шаблоны сообщений и информационный модуль

### Управление шаблонами

`GET /api/v1/messages/` — перечислить все шаблоны (`key`, `content`, `buttons`).

`GET /api/v1/messages/{key}` — получить конкретный шаблон.

`POST /api/v1/messages/{key}` — создать или обновить шаблон. Тело: `{ "content": "...", "buttons": [{"text": "Запись", "callback": "book"}] }`. Только для администраторов.

`DELETE /api/v1/messages/{key}` — удалить шаблон сообщения.

### Информационное сообщение и FAQ

`GET /api/v1/info`

- Возвращает объект с основным информационным текстом (`info`), кнопками (`buttons`) и сокращённым списком FAQ (`faqs`) для отображения пользователю.
- В админ‑панели текст и кнопки редактируются через шаблон с ключом `info`.

### Работа с FAQ

`GET /api/v1/faqs` — получить список вопросов (публично, без авторизации).

- **Параметры:** `limit`, `offset`, `sort_by` (`position`, `id`, `question_short`, `created_at`), `order`.

`GET /api/v1/faqs/{id}` — получить полный вопрос, ответ и вложения (публично, без авторизации).

`POST /api/v1/faqs` — создать запись (только администратор). Тело: `{ "question_short": "...", "question_full": "...", "answer": "...", "attachments": ["url"], "position": 2 }`.

`PUT /api/v1/faqs/{id}` — обновить запись (админ).

`DELETE /api/v1/faqs/{id}` — удалить запись (админ).

## Настройки

`GET /api/v1/settings` — перечислить все настройки. Каждая запись содержит `key`, `value`, `type`.

`GET /api/v1/settings/{key}` — получить значение настройки.

`POST /api/v1/settings/{key}` — создать или изменить настройку. Тело: `{ "value": "...", "type": "string|int|float|bool" }`. Значения сериализуются на основе `type`.

`DELETE /api/v1/settings/{key}` — удалить настройку.

Настройки используются для конфигурации бота, платёжных ключей и прочих параметров сервиса.  Например, ключ `waitlist_auto_promote` определяет, что делать при освобождении места на мероприятии:

- Если `waitlist_auto_promote=true` (значение по умолчанию), система автоматически создаёт бронирование для первого пользователя из листа ожидания.
- Если `waitlist_auto_promote=false`, вместо автоматического продвижения создаются задачи типа `waitlist` для каждого пользователя в очереди.  Боты доставляют уведомления с кнопкой «Записать», и только после нажатия создаётся новая бронь.  Это позволяет записывать людей поочерёдно.

Чтобы изменить параметр, выполните `POST /api/v1/settings/waitlist_auto_promote` с JSON `{ "value": false, "type": "bool" }`.

Сверхчувствительные данные (секреты) хранятся вне БД.

## Статистика

### Обзорная статистика

`GET /api/v1/statistics/overview`

- **Заголовки:** `Authorization`
- **Ответ:** объект с ключевыми числами: `users_count`, `events_count`, `bookings_count`, `payments_count`, `reviews_count`, `total_revenue` (сумма оплаченных платежей).
- **Ошибки:** `403 Forbidden` — только администраторы.

### Статистика по мероприятиям

`GET /api/v1/statistics/events`

- **Заголовки:** `Authorization`
- **Параметры:** `limit`, `offset`, `sort_by` (`total_bookings`, `paid_bookings`, `attended_bookings`, `revenue`, `title`), `order`.
- **Ответ:** массив, каждый элемент содержит:
  - `event_id`;
  - `title`, `start_time`, `price`, `max_participants`;
  - `total_bookings` — количество бронирований;
  - `paid_bookings` — оплаченные бронирования;
  - `attended_bookings` — бронирования с отметкой присутствия;
  - `revenue` — сумма платежей по событию.
- **Ошибки:** `403 Forbidden`.

### Статистика по платежам

`GET /api/v1/statistics/payments`

- **Заголовки:** `Authorization`
- **Параметры:**
  - `start_date` — ISO‑дата `YYYY-MM-DD`; включить платежи, созданные не ранее этой даты.
  - `end_date` — ISO‑дата `YYYY-MM-DD`; включить платежи, созданные до этой даты.
  - `group_by` — ключ агрегирования: `day` (по умолчанию), `month`, `event`, `provider` или `status`.
- **Ответ:** массив объектов, структура зависит от выбранного `group_by`:
  - `day`, `month` → поля `period`, `payments_count`, `total_amount`.
  - `event` → поля `event_id`, `payments_count`, `total_amount`.
  - `provider` → поля `provider`, `payments_count`, `total_amount`.
  - `status` → поля `status`, `payments_count`, `total_amount`.
- **Ошибки:** `403 Forbidden` — только администраторы.

### Статистика по бронированиям

`GET /api/v1/statistics/bookings`

- **Заголовки:** `Authorization`
- **Параметры:**
  - `start_date` — ISO‑дата `YYYY-MM-DD`; включить бронирования, созданные не ранее этой даты.
  - `end_date` — ISO‑дата `YYYY-MM-DD`; включить бронирования, созданные до этой даты.
  - `group_by` — ключ агрегирования: `day` (по умолчанию), `month`, `event` или `status`.
- **Ответ:** массив объектов, структура зависит от `group_by`:
  - `day`, `month` → поля `period`, `bookings_count`.
  - `event` → поля `event_id`, `bookings_count`.
  - `status` → поля `status`, `bookings_count`.
- **Ошибки:** `403 Forbidden` — только администраторы.

### Статистика по пользователям

`GET /api/v1/statistics/users`

- **Заголовки:** `Authorization`
- **Параметры:**
  - `start_date` — ISO‑дата `YYYY-MM-DD`; учитывать активность (бронирования и платежи) не ранее этой даты при подсчёте активных и платящих пользователей.
  - `end_date` — ISO‑дата `YYYY-MM-DD`; учитывать активность до этой даты.
  - `group_by` — единица агрегации: `social_provider` (по умолчанию), `role` или `none`.

**Ответ:** зависит от выбранного `group_by`:

- `social_provider` → массив объектов с полями:
  - `social_provider` — код сервиса или `internal`, если регистрация через e‑mail;
  - `users_count` — количество активных записей пользователей с данным провайдером (отфильтрованных по `disabled=0`).
- `role` → массив объектов с полями:
  - `role_id` — идентификатор роли (`1` — super_admin, `2` — admin, `3` — user);
  - `users_count` — количество активных пользователей с этой ролью.
- `none` → единственный объект с полями:
  - `active_users_count` — количество уникальных пользователей, совершивших хотя бы одно бронирование или платеж в указанный период (или за всё время, если даты не заданы);
  - `paying_users_count` — количество уникальных пользователей с хотя бы одним успешным платежом в указанный период.

**Ошибки:** `403 Forbidden` — только администраторы.

## Аудит

Сервис содержит таблицу `audit_logs`, предназначенную для записи всех действий пользователей и администраторов (создание, обновление, удаление). На данный момент в API нет эндпоинтов для просмотра аудита, но в будущем планируется `AuditService` с маршрутами:

- `GET /api/v1/audit/logs` — просмотр аудита с фильтрами по пользователю, типу действия и дате;
- `POST /api/v1/audit/logs` — запись произвольного события для сервисов, которым необходимо логировать действия.

## Общие замечания

- Все параметры запросов валидируются, а SQL‑операции выполняются через подготовленные выражения, что предотвращает SQL‑инъекции.
- Интеграция с ЮKassa полностью реализована: при создании платежа с провайдером `yookassa` сервис читает `yookassa_shop_id` и `yookassa_secret_key` из таблицы `settings`, формирует HTTPS‑запрос к `https://api.yookassa.ru/v3/payments` и возвращает реальный `external_id` и `confirmation_url`.  Чтобы включить этот функционал, задайте настройки `yookassa_shop_id` и `yookassa_secret_key` через эндпоинты `/api/v1/settings/<key>`.  Для надёжной фиксации статуса платежей рекомендуем настроить вебхуки ЮKassa.
- Некоторые каскадные операции (например, автоматический перенос пользователей из листа ожидания при освобождении мест) требуют дополнительной логики и пока не реализованы.

Этот документ отражает текущее состояние API и служит подробным справочником для разработчиков админ‑панели и Telegram‑бота.

## Задачи для ботов

Чтобы боты и внешние интеграции могли выполнять действия в нужный момент без обратного вызова, API предоставляет эндпоинты для работы с задачами.

### Получение задач

`GET /api/v1/tasks`

Возвращает список задач, которые нужно выполнить прямо сейчас или в ближайшее время, **только для указанного мессенджера**.  Каждый бот должен опрашивать этот эндпоинт не чаще одного раза в минуту, передавая свой идентификатор мессенджера через параметр `messenger`.  Если в системе запланирована рассылка для нескольких мессенджеров, для каждого из них будет создана отдельная задача.  Бот увидит только те задачи, которые соответствуют его каналу, и не получит задачи, уже отмеченные как выполненные.

Параметры запроса:

- `messenger` (обязательный) — строка с кодом мессенджера (`telegram`, `vk`, `max` и т.п.).
- `until` (опциональный) — ISO‑строка.  В ответ будут включены только задачи с датой `scheduled_at` меньше или равной этому времени.  Если параметр не указан, используется текущее время сервера.

Существует несколько типов задач:

- **Запланированные рассылки** (`type = "mailing"`) — записи из таблицы `mailings` со временем `scheduled_at`, которое уже наступило.  Задача содержит ID рассылки, заголовок и текст, а также дату/время выполнения.

- **Уведомления листа ожидания** (`type = "waitlist"`) — создаются, когда для события освобождается место, а автоматическое продвижение отключено (`waitlist_auto_promote=false`).  Каждая такая задача содержит идентификатор записи листа ожидания.  Бот, получивший задачу, должен отправить пользователю сообщение о доступном месте и кнопку **«Записать»**, которая вызывает `POST /api/v1/waitlist/{entry_id}/book`.  После того как пользователь подтвердит участие, все связанные задачи будут отмечены как выполненные.

Список типов может быть расширен (например, уведомления о новых тикетах поддержки) без изменения интерфейса.

Только супер‑администраторы, администраторы и боты с ролью администратора могут вызывать этот эндпоинт (RBAC проверяется через токен).

**Пример запроса**

```
GET /api/v1/tasks?messenger=telegram&until=2025-09-01T00:00:00
Authorization: Bearer <bot_token>
```

**Пример ответа**

```json
[
  {
    "id": 42,
    "type": "mailing",
    "title": "Анонс мероприятия",
    "description": "Сегодня состоится концерт...",
    "scheduled_at": "2025-08-29T18:00:00"
  },
  {
    "id": 43,
    "type": "waitlist",
    "title": "Доступно место: Йога‑курс",
    "description": "Для мероприятия Йога‑курс освободилось место. Нажмите кнопку \"Записать\" в чате, чтобы подтвердить своё участие.",
    "scheduled_at": null
  }
]
```

### Подтверждение выполнения

`POST /api/v1/tasks/{task_id}/complete`

После того как бот выполнил задачу (например, отправил рассылку всем пользователям своего мессенджера), он должен вызвать этот эндпоинт, чтобы отметить задачу как выполненную.  В теле запроса ничего передавать не нужно.

Если рассылка была предназначена для нескольких мессенджеров, задачи создаются отдельно для каждого.  Таким образом, когда бот Telegram завершает свою задачу и подтверждает её, эта задача больше не будет возвращаться Telegram‑боту, но останется доступной для бота Max или VK до тех пор, пока они не отправят своё подтверждение.

**Пример запроса**

```
POST /api/v1/tasks/42/complete
Authorization: Bearer <bot_token>
```

**Ответ**

```
204 No Content
```